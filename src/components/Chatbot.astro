---
---

<div id="chatbot-container" class="fixed bottom-4 right-4 z-50 flex flex-col items-end font-sans">
  <!-- Chat Window -->
  <div id="chat-window" class="hidden flex-col w-80 h-96 bg-[#111] border border-white/10 rounded-2xl shadow-2xl overflow-hidden mb-4 transition-all transform origin-bottom-right">
    <!-- Header -->
    <div class="bg-linear-to-r from-purple-900 to-blue-900 p-4 flex justify-between items-center border-b border-white/10">
      <div class="flex items-center gap-2">
        <span class="text-xl">ðŸ¦Ž</span>
        <div>
            <h3 class="font-bold text-white text-sm font-orbitron">LAG Assistant</h3>
            <p class="text-[10px] text-gray-300 flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Online</p>
        </div>
      </div>
      <button id="close-chat" class="cursor-pointer text-gray-400 hover:text-white transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>

    <!-- Messages Area -->
    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-[#0a0a0a] custom-scrollbar">
      <div class="flex items-start gap-2">
        <div class="w-8 h-8 rounded-full bg-purple-900/50 flex items-center justify-center text-lg border border-purple-500/30">ðŸ¦Ž</div>
        <div class="bg-white/5 p-3 rounded-2xl rounded-tl-none text-xs text-gray-300 max-w-[80%] border border-white/5">
          Â¡Hola! Soy el asistente de los LAG AWARDS. PregÃºntame sobre categorÃ­as, nominados o chismes del evento. 
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="p-3 bg-[#111] border-t border-white/10">
      <form id="chat-form" class="flex gap-2">
        <input 
          type="text" 
          id="chat-input" 
          placeholder="Escribe tu pregunta..." 
          class="flex-1 bg-white/5 border border-white/10 rounded-full px-4 py-2 text-xs text-white focus:outline-none focus:border-purple-500 transition-colors"
          autocomplete="off"
        />
        <button 
          type="submit" 
          class="cursor-pointer bg-purple-600 hover:bg-purple-700 text-white p-2 rounded-full transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
          </svg>
        </button>
      </form>
    </div>
  </div>

  <!-- Toggle Button -->
  <button id="toggle-chat" class="cursor-pointer group flex items-center justify-center w-14 h-14 bg-linear-to-br from-purple-600 to-blue-600 rounded-full shadow-[0_0_20px_rgba(147,51,234,0.5)] hover:scale-110 transition-all duration-300 border border-white/20">
    <span class="text-2xl group-hover:rotate-12 transition-transform">ðŸ’¬</span>
    <span class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-[#050505] animate-bounce"></span>
  </button>
</div>

<style>
  /* Scrollbar personalizada */
  .custom-scrollbar::-webkit-scrollbar { 
    width: 4px; 
  }
  .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
  .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

  /* ESTILOS PARA EL CONTENIDO DEL BOT (Listas y Negritas) */
  /* El selector :global() es necesario en Astro para afectar al HTML inyectado dinÃ¡micamente */
  :global(#messages ul) {
    list-style-type: disc;
    margin-left: 1.2rem;
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }
  
  :global(#messages li) {
    margin-bottom: 0.2rem;
  }

  :global(#messages strong) {
    color: #c084fc; /* Un tono morado claro para resaltar */
    font-weight: 800;
  }
</style>

<script>

  document.addEventListener('astro:page-load', () => {

  const toggleBtn = document.getElementById('toggle-chat');
  const closeBtn = document.getElementById('close-chat');
  const chatWindow = document.getElementById('chat-window');
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input') as HTMLInputElement;
  const messagesContainer = document.getElementById('messages');

  let isOpen = false;

  function toggleChat() {
    isOpen = !isOpen;
    if (isOpen) {
      chatWindow?.classList.remove('hidden');
      chatWindow?.classList.add('flex');
      toggleBtn?.classList.add('hidden');
      setTimeout(() => chatInput?.focus(), 100);
    } else {
      chatWindow?.classList.add('hidden');
      chatWindow?.classList.remove('flex');
      toggleBtn?.classList.remove('hidden');
    }
  }

  toggleBtn?.addEventListener('click', toggleChat);
  closeBtn?.addEventListener('click', toggleChat);

  function addMessage(text: string, sender: 'user' | 'bot') {
    if (!messagesContainer) return;

    const div = document.createElement('div');
    div.className = `flex items-start gap-2 ${sender === 'user' ? 'flex-row-reverse' : ''}`;
    
    const avatar = sender === 'bot' 
      ? '<div class="w-8 h-8 rounded-full bg-purple-900/50 flex items-center justify-center text-lg border border-purple-500/30 shrink-0">ðŸ¦Ž</div>'
      : '<div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-xs border border-white/10 shrink-0">ðŸ‘¤</div>';
    
    const bubbleClass = sender === 'bot'
      ? 'bg-white/5 rounded-tl-none text-gray-300 border-white/5'
      : 'bg-purple-600/20 rounded-tr-none text-white border-purple-500/20';

    div.innerHTML = `
      ${avatar}
      <div class="${bubbleClass} p-3 rounded-2xl text-xs max-w-[80%] border break-words">
        ${text}
      </div>
    `;

    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  function addTypingIndicator() {
    if (!messagesContainer) return null;
    const div = document.createElement('div');
    div.id = 'typing-indicator';
    div.className = 'flex items-start gap-2';
    div.innerHTML = `
      <div class="w-8 h-8 rounded-full bg-purple-900/50 flex items-center justify-center text-lg border border-purple-500/30 shrink-0">ðŸ¦Ž</div>
      <div class="bg-white/5 p-3 rounded-2xl rounded-tl-none border border-white/5 flex gap-1 items-center h-10">
        <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></span>
        <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
        <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
      </div>
    `;
    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    return div;
  }

  chatForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = chatInput.value.trim();
    if (!message) return;

    // User message
    addMessage(message, 'user');
    chatInput.value = '';
    chatInput.disabled = true;

    // Bot typing
    const typingIndicator = addTypingIndicator();

    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });

      const data = await res.json();
      
      if (typingIndicator) typingIndicator.remove();
      
      if (data.reply) {
        addMessage(data.reply, 'bot');
      } else {
        console.error('Error del servidor:', data.error);
        addMessage('Ups, tuve un error de conexiÃ³n. Revisa la consola.', 'bot');
      }
    } catch (error) {
      if (typingIndicator) typingIndicator.remove();
      console.error('Error de red:', error);
      addMessage('Error fatal. Me morÃ­. x_x', 'bot');
    } finally {
      chatInput.disabled = false;
      chatInput.focus();
    }
  });
  });
</script>
