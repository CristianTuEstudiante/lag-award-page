---
// src/pages/index.astro
import Layout from '../layouts/Layout.astro';
import Navbar from '../layouts/Navbar.astro';
import Hero from '../components/Hero.astro';
import Footer from '../layouts/Footer.astro';
import categories from '../data/categories';
import { getWinners } from '../lib/voting';

// 1. OBTENER GANADORES (Lógica Server-Side)
const EVENT_ID_2025 = '856a7c16-5436-4776-a844-04dcaafb4656'; // Tu UUID Real
const winnersData = await getWinners(EVENT_ID_2025);

// Helper para imágenes
const getOptimizedUrl = (url: string) => {
  if (!url) return "/img/lag_uconstr_placeholder.png";
  if (url.includes("res.cloudinary.com")) {
    // Pedimos una versión más pequeña (300px) para que cargue rápido en la home
    return url.replace("/upload/", "/upload/w_300,f_auto,q_auto/");
  }
  return url;
};

// Mapear ganadores
const winnersCompact = categories.map(cat => {
    const winnerInfo = winnersData.find((w: any) => w.category_id === cat.id);
    if (!winnerInfo) return null; 
    const nomineeDetails = cat.nominees.find(n => n.name === winnerInfo.nominee_name);
    
    return {
        category: cat,
        winnerName: winnerInfo.nominee_name,
        details: nomineeDetails || { image: '/img/tl_logo.png' }
    };
}).filter(item => item !== null);
---

<Layout 
  title="LAG AWARDS 2025 - Celebra con nosotros lo mejor de la comunidad" 
  description="Team LAG presenta a los ganadores de los LAG Awards 2025. Descubre a las leyendas elegidas por la comunidad en esta gala inolvidable."
  image="https://res.cloudinary.com/dkjaq3i9p/image/upload/v1765641379/TAREX_REND_TREEF_kqshzr.jpg"
>
    <Navbar />
    
    <main class="bg-[#050505] min-h-screen">
        <Hero />

        <section class="py-24 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full bg-[radial-gradient(ellipse_at_top,var(--tw-gradient-stops))] from-yellow-900/10 via-[#050505] to-[#050505] pointer-events-none"></div>

            <div class="container mx-auto px-4 md:px-6 relative z-10">
                
                <div class="flex flex-col md:flex-row justify-between items-end mb-12 gap-4">
                    <div>
                        <h2 class="text-3xl md:text-5xl font-black font-orbitron text-white mb-2">
                            SALÓN DE LA FAMA
                        </h2>
                        <p class="text-gray-400">Los ganadores de la edición 2025.</p>
                    </div>
                    <a href="/ganadores" class="text-yellow-500 hover:text-yellow-400 font-bold text-sm tracking-widest uppercase border border-yellow-500/30 hover:border-yellow-500 px-6 py-2 rounded-full transition-all">
                        Ver Gala Completa →
                    </a>
                </div>

                {winnersCompact.length > 0 ? (
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6">
                        {winnersCompact.map((item) => (
                            <a href="/ganadores" class="group relative aspect-3/4 bg-[#111] rounded-xl overflow-hidden border border-white/5 hover:border-yellow-500/50 transition-all duration-300 hover:-translate-y-1 hover:shadow-lg hover:shadow-yellow-500/10">
                                
                                <div class="absolute inset-0">
                                    {item.details.youtubeId ? (
                                        <img 
                                            src={`https://img.youtube.com/vi/${item.details.youtubeId}/hqdefault.jpg`} 
                                            alt={item.winnerName} 
                                            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 filter brightness-75 group-hover:brightness-100"
                                            loading="lazy"
                                        />
                                    ) : (
                                        <img 
                                            src={getOptimizedUrl(item.details.image || (item.details.video ? item.details.video.replace(/\.[^/.]+$/, ".jpg") : '')) || '/img/tl_logo.png'} 
                                            alt={item.winnerName} 
                                            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 filter brightness-75 group-hover:brightness-100"
                                            loading="lazy"
                                        />
                                    )}
                                </div>

                                <div class="absolute inset-0 bg-linear-to-t from-black via-black/50 to-transparent opacity-90"></div>

                                <div class="absolute inset-0 p-4 flex flex-col justify-between">
                                    
                                    <div class="flex justify-between items-start">
                                        <div class="bg-yellow-500/90 text-black text-[10px] font-black px-2 py-1 rounded uppercase tracking-wider">
                                            GANADOR
                                        </div>
                                        <span class="text-xl drop-shadow-md filter grayscale group-hover:grayscale-0 transition-all">{item.category.icon}</span>
                                    </div>

                                    <div>
                                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-1 truncate">
                                            {item.category.title}
                                        </p>
                                        <h3 class="text-lg md:text-xl font-bold font-orbitron text-white leading-tight line-clamp-2 group-hover:text-yellow-400 transition-colors">
                                            {item.winnerName}
                                        </h3>
                                    </div>
                                </div>
                            </a>
                        ))}
                    </div>
                ) : (
                    <div class="py-20 text-center border border-white/5 rounded-2xl bg-white/5">
                        <p class="text-gray-500">Calculando resultados...</p>
                    </div>
                )}

            </div>
        </section>

    </main>
    <Footer />
</Layout>