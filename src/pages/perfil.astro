---
import Layout from '../layouts/Layout.astro';
import Navbar from '../layouts/Navbar.astro';
import Footer from '../layouts/Footer.astro';
import { $currentUser } from '../stores/authStore';

const user = $currentUser.get();
---

<Layout title="Mi Perfil - LAGAWARDS">
  <Navbar />
  
  <main class="pt-24 min-h-screen text-white relative overflow-hidden bg-[#050505]">
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_top_right,var(--tw-gradient-stops))] from-blue-900/10 via-black to-black -z-10"></div>
    
    <div class="container mx-auto px-6 py-12 max-w-3xl"> <div id="loading-state" class="flex flex-col items-center justify-center py-20">
          <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mb-4"></div>
      </div>

      <div id="profile-content" class="hidden opacity-0 transition-opacity duration-500">
        
        <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-10">
            
            <div class="flex items-center gap-5 w-full md:w-auto">
                <img 
                    id="profile-avatar"
                    src="" 
                    alt="Avatar" 
                    class="w-20 h-20 md:w-24 md:h-24 rounded-full object-cover border-2 border-white/20"
                />
                <div>
                    <h2 id="profile-name" class="text-2xl md:text-3xl font-bold font-orbitron text-white">Usuario</h2>
                    <p id="profile-email" class="text-sm text-gray-500 font-mono">...</p>
                </div>
            </div>

            <div class="w-full md:w-auto">
        <div class="bg-[#0a0a0a] border border-white/10  p-2 min-w-[280px] shadow-2xl relative overflow-hidden">
            
            <div class="flex flex-col gap-3">
                
                <div id="badge-voter" class="flex items-center gap-4 opacity-30 grayscale transition-all duration-700 ease-out p-2 rounded-lg border border-transparent">
                    
                    <div class="relative shrink-0">
                        <div id="badge-glow" class="absolute inset-0 bg-yellow-500 blur-lg opacity-0 transition-opacity duration-700"></div>
                        <img src="/img/tl_logo.png" alt="Insignia Votante" class="w-14 h-14 relative z-10" />
                    </div>
                    
                    <div class="flex flex-col">
                        <span class="text-[10px] font-bold tracking-[0.2em] text-blue-300/70 uppercase">Insignia</span>
                        <span class="text-lg font-bold text-white leading-none">Votante Lag Awards 2025</span>
                    </div>
                </div>

            </div>
        </div>
    </div>
        </div>

        <div class="border-2 border-white rounded-none md:rounded-lg overflow-hidden bg-[#0a0a0a]">
            
            <button id="votes-toggle" class="cursor-pointer w-full px-4 py-1 bg-white text-black flex justify-between items-center hover:bg-gray-200 transition-colors group">
                <h3 class="text-xl md:text-sm font-black font-orbitron uppercase tracking-tighter">
                    LAG AWARDS 2025 VOTOS
                </h3>
                <div class="flex items-center gap-3">
                    <span id="vote-count-badge" class="text-xs font-bold bg-black text-white px-2 py-1 rounded hidden md:block">0 Votos</span>
                    <svg id="chevron-icon" class="w-6 h-6 transform transition-transform duration-300 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </button>

            <div id="votes-content" class="hidden transition-all duration-300 ease-in-out border-t border-white/10">
                <div class="p-2 bg-[#111]">
                    <div id="votes-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                        </div>
                </div>
            </div>
        </div>

      </div>

      <div id="unauthorized-message" class="hidden text-center py-20">
        <h2 class="text-2xl font-bold text-red-500 mb-4">Acceso Restringido</h2>
        <a href="/login" class="underline hover:text-white">Iniciar Sesión</a>
      </div>

    </div>
  </main>
  <Footer />
</Layout>

<script>
    import { $currentUser } from '../stores/authStore';
    import { getUserVotes } from '../lib/voting';
    import categories from '../data/categories';

    document.addEventListener('astro:page-load', async () => {
        // Referencias DOM
        const loadingState = document.getElementById('loading-state');
        const profileContent = document.getElementById('profile-content');
        const unauthorizedMsg = document.getElementById('unauthorized-message');
        const avatarEl = document.getElementById('profile-avatar') as HTMLImageElement;
        const nameEl = document.getElementById('profile-name');
        const emailEl = document.getElementById('profile-email');
        
        // Referencias del Acordeón
        const toggleBtn = document.getElementById('votes-toggle');
        const votesContent = document.getElementById('votes-content');
        const chevron = document.getElementById('chevron-icon');
        const votesGrid = document.getElementById('votes-grid');
        const voteCountBadge = document.getElementById('vote-count-badge');
        const badgeVoter = document.getElementById('badge-voter');
        const badgeGlow = document.getElementById('badge-glow');
        // 1. Lógica del Acordeón
        if(toggleBtn && votesContent && chevron) {
            toggleBtn.addEventListener('click', () => {
                const isHidden = votesContent.classList.contains('hidden');
                if (isHidden) {
                    votesContent.classList.remove('hidden');
                    chevron.style.transform = 'rotate(180deg)';
                } else {
                    votesContent.classList.add('hidden');
                    chevron.style.transform = 'rotate(0deg)';
                }
            });
        }

        // 2. Verificar Usuario
        let user = $currentUser.get();
        if (!user) {
            await new Promise(r => setTimeout(r, 500));
            user = $currentUser.get();
        }

        if (!user) {
            loadingState.classList.add('hidden');
            unauthorizedMsg.classList.remove('hidden');
            return;
        }

        // 3. Renderizar Datos Usuario
        const userName = user.user_metadata?.full_name || 'Usuario';
        const userImg = user.user_metadata?.avatar_url || user.user_metadata?.picture || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=random`;

        if(avatarEl) avatarEl.src = userImg;
        if(nameEl) nameEl.textContent = userName;
        if(emailEl) emailEl.textContent = user.email;

        // 4. Renderizar Votos (Casillas Pequeñas)
        const myVotes = await getUserVotes();
        
        if (votesGrid) {
            votesGrid.innerHTML = '';
            let count = 0;

            categories.forEach(cat => {
                const votedName = myVotes[cat.id];
                if (votedName) {
                    count++;
                    // Estilo "Casilla Pequeña"
                    const box = document.createElement('div');
                    box.className = 'bg-white/5 border border-white/10 rounded-lg p-2 flex flex-col items-center justify-center text-center gap-2 hover:bg-white/10 hover:border-purple-500/50 transition-all group/box cursor-default h-16 relative overflow-hidden';
                    
                    box.innerHTML = `
                        <div class="absolute top-1 right-2 text-green-500 text-xs opacity-50">✓</div>
                        <div class="w-full overflow-hidden">
                            <p class="text-[10px] text-gray-400 uppercase font-bold truncate px-1">${cat.title}</p>
                            <p class="text-xs text-white font-bold leading-tight mt-1 line-clamp-2 text-blue-300">${votedName}</p>
                        </div>
                    `;
                    votesGrid.appendChild(box);
                }
            });
            if (count > 0 && badgeVoter) {
                // ACTIVAR INSIGNIA si hay al menos 1 voto
                badgeVoter.classList.remove('opacity-30', 'grayscale');
                badgeVoter.classList.add('bg-white/5', 'border-white/10'); // Añadir fondo sutil al activarse
                if(badgeGlow) badgeGlow.classList.remove('opacity-0');
                if(badgeGlow) badgeGlow.classList.add('opacity-40');
            } else if (count === 0) {
                // MENSAJE SIN VOTOS
                votesGrid.className = "flex flex-col items-center justify-center py-8 w-full"; 
                votesGrid.innerHTML = `
                    <p class="text-gray-500 italic text-sm mb-4">Aún no has participado en las votaciones.</p>
                    <a href="/categorias" class="text-xs bg-white text-black px-6 py-2 font-bold rounded-full hover:bg-gray-200 hover:scale-105 transition-all">IR A VOTAR</a>
                `;
            }
            
            if(voteCountBadge) voteCountBadge.textContent = `${count} Votos`;
        }
        

        // Mostrar todo
        loadingState.classList.add('hidden');
        profileContent.classList.remove('hidden');
        setTimeout(() => profileContent.classList.remove('opacity-0'), 50);
    });
</script>