---
import Layout from '../layouts/Layout.astro';
import Navbar from '../layouts/Navbar.astro';
import Footer from '../layouts/Footer.astro';
// ðŸ‘‡ Importamos el nuevo componente
import UserInfo from '../components/profile/UserInfo.astro'; 
import { $currentUser } from '../stores/authStore';

const user = $currentUser.get();
---

<Layout title="Mi Perfil - LAGAWARDS">
  <Navbar />
  
  <main class="pt-24 min-h-screen text-white relative overflow-hidden bg-[#050505]">
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_top_right,var(--tw-gradient-stops))] from-blue-900/10 via-black to-black -z-10"></div>
    
    <div class="container mx-auto px-6 py-12 max-w-3xl"> 
      
      <div id="loading-state" class="flex flex-col items-center justify-center py-20">
          <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mb-4"></div>
      </div>

      <div id="profile-content" class="hidden opacity-0 transition-opacity duration-500">
        
        <UserInfo />

        <div id="votes-accordion" class="hidden border-2 border-white rounded-none md:rounded-lg overflow-hidden bg-[#0a0a0a] mt-10">
            <button id="votes-toggle" class="cursor-pointer w-full px-4 py-1 bg-white text-black flex justify-between items-center hover:bg-gray-200 transition-colors group">
                <h3 class="text-xl md:text-sm font-black font-orbitron uppercase tracking-tighter">
                    TUS VOTOS 2025
                </h3>
                <div class="flex items-center gap-3">
                    <span id="vote-count-badge" class="text-xs font-bold bg-black text-white px-2 py-1 rounded hidden md:block">0 Votos</span>
                    <svg id="chevron-icon" class="w-6 h-6 transform transition-transform duration-300 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </button>

            <div id="votes-content" class="hidden transition-all duration-300 ease-in-out border-t border-white/10">
                <div class="p-2 bg-[#111]">
                    <div id="votes-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                        </div>
                </div>
            </div>
        </div>

      </div>

      <div id="unauthorized-message" class="hidden text-center py-20">
        <h2 class="text-2xl font-bold text-red-500 mb-4">Acceso Restringido</h2>
        <a href="/login" class="underline hover:text-white">Iniciar SesiÃ³n</a>
      </div>

    </div>
  </main>
  <Footer />
</Layout>

<script>
    // ... (MANTÃ‰N TU SCRIPT EXACTAMENTE IGUAL QUE ANTES) ...
    // ... (El script encontrarÃ¡ los IDs dentro de <UserInfo /> automÃ¡ticamente) ...
    
    import { $currentUser } from '../stores/authStore';
    import { getUserVotes } from '../lib/voting';
    import categories from '../data/categories';
    import { supabase } from '../lib/supabase';

    document.addEventListener('astro:page-load', async () => {
        // ... (Copia y pega tu script funcional aquÃ­) ...
        // AsegÃºrate de incluir la lÃ³gica del botÃ³n de cerrar sesiÃ³n que agreguÃ© en el HTML nuevo
        document.getElementById('sign-out-btn')?.addEventListener('click', async (e) => {
            e.preventDefault();
            const { error } = await supabase.auth.signOut();
            if (!error) window.location.href = '/login';
        });
        
        // ... Resto de la lÃ³gica de carga ...
        const loadingState = document.getElementById('loading-state');
        const profileContent = document.getElementById('profile-content');
        const unauthorizedMsg = document.getElementById('unauthorized-message');
        const avatarEl = document.getElementById('profile-avatar') as HTMLImageElement;
        const nameEl = document.getElementById('profile-name');
        const emailEl = document.getElementById('profile-email');
        const badgeContainer = document.getElementById('badge-container');
        const votesAccordion = document.getElementById('votes-accordion');
        const votesGrid = document.getElementById('votes-grid');
        const voteCountBadge = document.getElementById('vote-count-badge');
        const toggleBtn = document.getElementById('votes-toggle');
        const votesContent = document.getElementById('votes-content');
        const chevron = document.getElementById('chevron-icon');

        if(toggleBtn && votesContent && chevron) {
            toggleBtn.addEventListener('click', () => {
                const isHidden = votesContent.classList.contains('hidden');
                if (isHidden) {
                    votesContent.classList.remove('hidden');
                    chevron.style.transform = 'rotate(180deg)';
                } else {
                    votesContent.classList.add('hidden');
                    chevron.style.transform = 'rotate(0deg)';
                }
            });
        }

        let user = $currentUser.get();
        if (!user) {
            await new Promise(r => setTimeout(r, 500));
            user = $currentUser.get();
        }

        if (!user) {
            loadingState.classList.add('hidden');
            unauthorizedMsg.classList.remove('hidden');
            return;
        }

        const userName = user.user_metadata?.full_name || 'Usuario';
        const userImg = user.user_metadata?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=random`;

        if(avatarEl) avatarEl.src = userImg;
        if(nameEl) nameEl.textContent = userName;
        if(emailEl) emailEl.textContent = user.email;

        const myVotes = await getUserVotes();
        const voteKeys = Object.keys(myVotes);
        const count = voteKeys.length;

        if (count > 0) {
            badgeContainer?.classList.remove('hidden');
            votesAccordion?.classList.remove('hidden');

            if (votesGrid) {
                votesGrid.innerHTML = '';
                categories.forEach(cat => {
                    const votedName = myVotes[cat.id];
                    if (votedName) {
                        const box = document.createElement('div');
                        box.className = 'bg-white/5 border border-white/10 rounded-lg p-2 flex flex-col items-center justify-center text-center gap-2 hover:bg-white/10 hover:border-purple-500/50 transition-all group/box cursor-default h-16 relative overflow-hidden';
                        
                        box.innerHTML = `
                            <div class="absolute top-1 right-2 text-green-500 text-xs opacity-50">âœ“</div>
                            <div class="w-full overflow-hidden">
                                <p class="text-[10px] text-gray-400 uppercase font-bold truncate px-1">${cat.title}</p>
                                <p class="text-xs text-white font-bold leading-tight mt-1 line-clamp-2 text-blue-300">${votedName}</p>
                            </div>
                        `;
                        votesGrid.appendChild(box);
                    }
                });
            }
            if(voteCountBadge) voteCountBadge.textContent = `${count} Votos`;

        } else {
            badgeContainer?.classList.add('hidden');
            votesAccordion?.classList.add('hidden');
        }

        loadingState.classList.add('hidden');
        profileContent.classList.remove('hidden');
        setTimeout(() => profileContent.classList.remove('opacity-0'), 50);
    });
</script>