---
const links = [
  { name: 'Informacion', href: '/info' },
  { name: 'Categorias', href: '/categorias' },
  { name: 'Premiacion', href: '/premiacion' },
  { name: 'Historia', href: '/historia' },
];
---

<!-- Unanavbarparalgordolagartoputo -->
<nav class="fixed top-0 left-0 w-full z-50 backdrop-blur-md bg-black/40 border-b border-white/10 shadow-lg transition-all duration-300">
    <div class="container mx-auto px-6 py-3">
        <div class="flex justify-between items-center">
            
            <div class="md:hidden flex w-full justify-between items-center">
                <a href="/" class="flex items-center gap-2 select-none hover:scale-105 transition-transform duration-300 z-10">
                    <img src="/img/tl_logo.png" alt="Logo LAG Awards" class="h-12 w-auto drop-shadow-[0_0_10px_rgba(220,38,38,0.6)]" />
                </a>
                <button id="menu-toggle" class="text-white focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                    </svg>
                </button>
            </div>

            <div class="hidden md:flex w-full items-center justify-between">
                <div class="flex-1 flex justify-end items-center space-x-8 pr-8">
                    <a href={links[0].href} class="nav-link font-bold tracking-wider hover:text-yellow-400 transition-colors">{links[0].name}</a>
                    <a href={links[1].href} class="nav-link font-bold tracking-wider hover:text-yellow-400 transition-colors">{links[1].name}</a>
                </div>

                <div class="flex-none px-6">
                    <a href="/" class="flex items-center gap-2 select-none hover:scale-110 transition-transform duration-300">
                        <img src="/img/tl_logo.png" alt="Logo" class="h-14 w-auto drop-shadow-[0_0_15px_rgba(220,38,38,0.5)]" />
                    </a>
                </div>

                <div class="flex-1 flex justify-start items-center space-x-8 pl-8">
                    <a href={links[2].href} class="nav-link font-bold tracking-wider hover:text-yellow-400 transition-colors">{links[2].name}</a>
                    <a href={links[3].href} class="nav-link font-bold tracking-wider hover:text-yellow-400 transition-colors">{links[3].name}</a>
                    
                    <div class="ml-4 pl-4 border-l border-white/20 h-8 flex items-center">
                        <a 
                          id="btn-login-link" 
                          href="/login" 
                          class="flex items-center gap-2 px-3 py-1.5 bg-white/10 hover:bg-white/20 border border-white/20 rounded-full text-xs font-bold text-white transition-all hover:scale-105 backdrop-blur-sm"
                        >
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                            </svg>
                            LOGIN
                        </a>

                        <div id="user-profile" class="hidden flex items-center gap-3">
    <a href="/perfil" class="block">
        <img 
            id="user-avatar" 
            src="" 
            alt="Perfil" 
            class="w-9 h-9 rounded-full border-2 border-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.5)] object-cover cursor-pointer hover:scale-110 transition-transform" 
            title="Ir a mi perfil"
        />
    </a>
    
    <button 
        id="btn-logout" 
        class="cursor-pointer text-xs font-bold text-red-400 hover:text-red-300 border border-red-500/30 bg-red-500/10 px-2 py-1 rounded hover:bg-red-500/20 transition-colors"
    >
        SALIR
    </button>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="mobile-menu" class="hidden md:hidden bg-black/95 backdrop-blur-xl border-t border-white/10 absolute w-full">
        <div class="flex flex-col items-center py-6 space-y-4">
            {links.map(link => (
                <a href={link.href} class="text-lg font-orbitron text-gray-300 hover:text-yellow-400 transition-colors">{link.name}</a>
            ))}
            <hr class="w-1/2 border-white/10 my-2" />
            <a id="mobile-login-btn" href="/login" class="px-6 py-2 bg-white text-black font-bold rounded-full">Iniciar Sesión</a>
        </div>
    </div>
</nav>

<style>
	/* Pequeña animación de aparición suave */
	@keyframes navFade {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    nav {
        animation: navFade 0.8s ease-out forwards;
    }

	

	.nav-link:hover {
        text-shadow: 0 0 8px rgba(250, 204, 21, 0.7);
    }

    /* El estilo de hover para text-shadow no se puede hacer directamente con Tailwind, así que lo mantenemos aquí */
    a:hover {
        text-shadow: 0 0 8px rgba(250, 204, 21, 0.7);
    }
</style>

<script>
  import { supabase } from '../lib/supabase';
  import { $currentUser } from '../stores/authStore';

  // Ejecutar lógica cada vez que Astro carga o cambia de página
  document.addEventListener('astro:page-load', () => {
      
      // 1. OBTENER ELEMENTOS DEL DOM (Siempre frescos)
      const btnLoginLink = document.getElementById('btn-login-link');
      const userProfile = document.getElementById('user-profile');
      const userAvatar = document.getElementById('user-avatar');
      const mobileLoginBtn = document.getElementById('mobile-login-btn');
      const btnLogout = document.getElementById('btn-logout');
      const menuToggle = document.getElementById('menu-toggle');
      const mobileMenu = document.getElementById('mobile-menu');


      // 2. FUNCIÓN DE ACTUALIZACIÓN DE UI
      const updateUI = (user) => {
          if (!btnLoginLink || !userProfile || !userAvatar) return; // Protección si el DOM no está listo

          if (user) {
              // --- MODO: LOGUEADO ---
              btnLoginLink.classList.add('hidden');

              // Forzamos que se muestre el perfil
              userProfile.classList.remove('hidden');
              userProfile.classList.add('flex'); 

              // LÓGICA ROBUSTA DE IMAGEN

              const avatarUrl = user.user_metadata?.avatar_url || user.user_metadata?.picture;

              const userName = user.user_metadata?.full_name || user.email || 'User';
              
              // Si no hay foto, usamos UI Avatars con las iniciales del usuario
              const fallbackUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=random&color=fff&bold=true`;

              userAvatar.src = avatarUrl || fallbackUrl;
              
              // Si la imagen de Google falla al cargar, cambiamos al fallback inmediatamente
              userAvatar.onerror = () => {
                  userAvatar.src = fallbackUrl;
              };

              if (mobileLoginBtn) {
                  mobileLoginBtn.textContent = 'Mi Cuenta';

                  // MODIFICADO: Redirige a la nueva página de perfil
                  mobileLoginBtn.href = '/perfil';
              }
              
              // NUEVO: Agregar un listener para que el avatar redirija a /perfil
              if (userAvatar && !userAvatar.hasAttribute('data-listener-attached')) {
                  userAvatar.addEventListener('click', (e) => {
                      e.preventDefault(); 
                      window.location.href = '/perfil';
                  });
                  userAvatar.setAttribute('data-listener-attached', 'true');
          }

      } else { 
              // --- MODO: NO LOGUEADO ---
              btnLoginLink.classList.remove('hidden');
              userProfile.classList.add('hidden');
              userProfile.classList.remove('flex');

              if (mobileLoginBtn) {
                  mobileLoginBtn.textContent = 'Iniciar Sesión';
                  mobileLoginBtn.href = '/login';
              }
          }
      };

      // 3. VERIFICAR ESTADO ACTUAL (Al cargar la página)
      const current = $currentUser.get();
      if (current) {
          updateUI(current);
      } else {
          // Si no hay store, preguntar a Supabase (persistencia)
          supabase.auth.getSession().then(({ data: { session } }) => {
              if (session?.user) {
                  $currentUser.set(session.user);
                  updateUI(session.user);
              } else {
                  updateUI(null);
              }
          });
      }

      // 4. ESCUCHAR CAMBIOS EN EL STORE (Para login/logout dinámico)
      const unsubscribe = $currentUser.subscribe(user => {
          updateUI(user);
      });

      // 5. EVENT LISTENERS
      // Logout
      if (btnLogout) {
          // Clonamos el nodo para eliminar listeners viejos (truco para evitar duplicados en Astro)
          const newBtn = btnLogout.cloneNode(true);
          btnLogout.parentNode.replaceChild(newBtn, btnLogout);
          
          newBtn.addEventListener('click', async () => {
              await supabase.auth.signOut();
              $currentUser.set(null);
              window.location.href = '/'; // Recarga completa para limpiar estado
          });
      }

      // Mobile Menu
      if (menuToggle && mobileMenu) {
          const newToggle = menuToggle.cloneNode(true);
          menuToggle.parentNode.replaceChild(newToggle, menuToggle);

          newToggle.addEventListener('click', () => {
              mobileMenu.classList.toggle('hidden');
          });
      }
  });
</script>